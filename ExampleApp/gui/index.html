<!DOCTYPE html>

<html>
    <head>
        <title>IP Lookup</title>
        <style>
            ul {
                list-style: none;
            }
            li {
                display: inline-block;
            }
            .map {
                  height: 400px;
                  width: 100%;
            }
            .ol-popup {
                font-family: 'Lucida Grande', Verdana, Geneva, Lucida, Arial, Helvetica, sans-serif !important;
                font-size: 12px;
                position: absolute;
                background-color: white;
                -webkit-filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
                filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
                padding: 15px;
                border-radius: 10px;
                border: 1px solid #cccccc;
                bottom: 12px;
                left: -50px;
                min-width: 100px;
            }
            #search-content {
                text-align: center;
            }
        </style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/css/ol.css" type="text/css">
    </head>

    <body>
        <div>
            <div id="search-content">
                <p id="error"></p>
                <h1>Input an IP Address</h1>
                <input type="text" placeholder="IP Address" id="ip"><br/>
                <input type="button" value="Lookup" onclick="checkIP();">
            </div>
            <br/>
            <br/>
            <div id="response" style="display: none;">
                <h2>IP Address Data Feedback</h2>
                <ul>
                    <!--<li>IP Address: <p id="ip"></p></li>-->
                    <li id="public"></li><br/>
                    <li id="version"></li><br/>
                    <li id="domain"></li><br/>
                    <li id="country"></li><br/>
                    <li id="location"></li><br/>
                    <li id="isp"></li><br/>
                    <li id="abusescore"></li><br/>
                    <li id="usage"></li>
                </ul>
                <br/>
                <div id="map" class="map"></div>
                <div id="popup" class="ol-popup">
                    <!--<a href="#" id="popup-closer" class="ol-popup-closer"></a>-->
                    <div id="popup-content"></div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/build/ol.js"></script>
        <script defer src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <script defer>
            async function checkIP() {
                const ip = document.getElementById("ip").value;
                axios.get(`http://localhost:8000/abuse/${ip}`)
                    .then(data => {
                        document.getElementById("response").style.display = "block";
                        const response = JSON.parse(data.data).data;
                        document.getElementById("country").innerHTML = `<b>Country:</b> ${response.countryCode || "Unknown"}`;
                        document.getElementById("public").innerHTML = `<b>Public IP:</b> ${response.isPublic ? "Yes" : "No"}`;
                        //document.getElementById("ip").innerText = ip;
                        document.getElementById("isp").innerHTML = `<b>ISP:</b> ${response.isp}`;
                        document.getElementById("usage").innerHTML = `<b>Usage:</b> ${response.usageType}`;
                        document.getElementById("abusescore").innerHTML = `<b>Abuse Score:</b> ${response.abuseConfidenceScore}`;
                        document.getElementById("domain").innerHTML = response.domain ? `<b>Domain:</b> <a href='https://${response.domain}' target="_blank">${response.domain}</a>` : `<b>Domain:</b> Unknown`;
                        document.getElementById("version").innerHTML = `<b>IP Version:</b> IPv${response.ipVersion}`;

                        const location = {latitude: null, longitude: null};
                        const lat = new XMLHttpRequest();
                        const long = new XMLHttpRequest();

                        lat.addEventListener("load", function() {
                            location.latitude = this.response;
                            long.addEventListener("load", function() {
                                location.longitude = this.response;
                                document.getElementById("location").innerHTML = `<b>Latitude:</b> ${location.latitude.split('"').join("") == "Undefined" ? "Unknown" : location.latitude.split('"').join("")}</li><br/><li><b>Longitude:</b> ${location.longitude.split('"').join("") == "Undefined" ? "Unknown" : location.longitude.split('"').join("")}`;
                                
                                document.getElementById("map").innerHTML = "";
                                if (location.latitude.split('"').join("") == "Undefined" || location.longitude.split('"').join("") == "Undefined")
                                    return;
                                const map = new ol.Map({
                                    target: 'map',
                                    layers: [
                                        new ol.layer.Tile({
                                            source: new ol.source.OSM()
                                        }),
                                        new ol.layer.Vector({
                                            source: new ol.source.Vector({
                                                features: [
                                                    new ol.Feature({
                                                        geometry: new ol.geom.Point(ol.proj.fromLonLat([
                                                            parseFloat(location.longitude.split('"').join("")), 
                                                            parseFloat(location.latitude.split('"').join(""))
                                                        ]))
                                                    })
                                                ]
                                            })
                                        })
                                    ],
                                    view: new ol.View({
                                        center: ol.proj.fromLonLat([
                                            parseFloat(location.longitude.split('"').join("")), 
                                            parseFloat(location.latitude.split('"').join(""))
                                        ]),
                                        zoom: 15
                                    })
                                });
                                let container = document.getElementById('popup');
                                if (!container) {
                                    container = document.createElement("div");
                                    container.id = "popup";
                                    container.classList.add("ol-popup");
                                    document.getElementById("response").append(container);
                                }
                                let content = document.getElementById('popup-content');
                                if (!content) {
                                    content = document.createElement("div");
                                    content.id = "popup-content";
                                    container.append(content);
                                }
                                const overlay = new ol.Overlay({
                                    element: container,
                                    autoPan: true,
                                    autoPanAnimation: {
                                        duration: 250
                                    }
                                });
                                map.addOverlay(overlay);

                                content.innerHTML = `<b>${response.domain}</b><br/>${[
                                    location.longitude.split('"').join(""), 
                                    location.latitude.split('"').join("")
                                ].map(e => parseFloat(e).toFixed(2)).join(", ")}`;
                                overlay.setPosition(ol.proj.fromLonLat([
                                    parseFloat(location.longitude.split('"').join("")), 
                                    parseFloat(location.latitude.split('"').join(""))
                                ]));
                            });
                            long.open("GET", `http://localhost:8000/abuse/${ip}/longitude`);
                            long.send();
                        });
                        lat.open("GET", `http://localhost:8000/abuse/${ip}/latitude`);
                        lat.send();
                    })
                    .catch(err => {
                       document.getElementById("error").value = err.message;
                    });
                }
        </script>
    </body>
</html>